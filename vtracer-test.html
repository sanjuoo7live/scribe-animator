<!DOCTYPE html>
<html>
<head>
    <title>VTracer WASM Test Suite</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .test-pass { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .test-fail { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .test-warn { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .test-info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        
        .image-test {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            align-items: flex-start;
        }
        .test-image {
            max-width: 200px;
            max-height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-svg {
            max-width: 200px;
            max-height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        
        .progress {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            border: 1px solid #e9ecef;
        }
    </style>
</head>
<body>
    <h1>ðŸ§ª VTracer WASM Test Suite</h1>
    <div class="test-container">
        <h2>Environment Check</h2>
        <div id="env-tests"></div>
        <button id="run-env-tests">Run Environment Tests</button>
    </div>
    
    <div class="test-container">
        <h2>WASM Loading Tests</h2>
        <div id="wasm-tests"></div>
        <button id="run-wasm-tests">Run WASM Tests</button>
    </div>
    
    <div class="test-container">
        <h2>Image Processing Tests</h2>
        <div id="image-tests"></div>
        <button id="run-image-tests">Run Image Tests</button>
        <div class="progress">
            <div class="progress-bar" id="image-progress"></div>
        </div>
    </div>
    
    <div class="test-container">
        <h2>Test Results</h2>
        <div id="test-results"></div>
        <button id="export-results">Export Results</button>
    </div>

    <script type="module">
        const logResult = (container, type, message, details = null) => {
            const div = document.createElement('div');
            div.className = `test-result test-${type}`;
            div.innerHTML = `<strong>${message}</strong>`;
            if (details) {
                const pre = document.createElement('pre');
                pre.textContent = typeof details === 'object' ? JSON.stringify(details, null, 2) : details;
                div.appendChild(pre);
            }
            container.appendChild(div);
            console.log(`[${type.toUpperCase()}] ${message}`, details);
        };

        // Environment Tests
        document.getElementById('run-env-tests').onclick = async () => {
            const container = document.getElementById('env-tests');
            container.innerHTML = '';
            
            logResult(container, 'info', 'Testing browser environment...');
            
            // Check basic APIs
            const checks = [
                ['WebAssembly', typeof WebAssembly !== 'undefined'],
                ['WebWorkers', typeof Worker !== 'undefined'],
                ['OffscreenCanvas', typeof OffscreenCanvas !== 'undefined'],
                ['ImageData', typeof ImageData !== 'undefined'],
                ['Dynamic imports', true] // We're using it right now
            ];
            
            for (const [name, available] of checks) {
                logResult(container, available ? 'pass' : 'fail', `${name}: ${available ? 'Available' : 'Not available'}`);
            }
            
            // Check file availability
            try {
                const response = await fetch('/assets/tools/vtracer/vtracer_real.js');
                logResult(container, response.ok ? 'pass' : 'fail', 
                    `vtracer_real.js: ${response.ok ? 'Found' : 'Not found'} (${response.status})`);
            } catch (e) {
                logResult(container, 'fail', 'vtracer_real.js: Fetch failed', e.message);
            }
            
            try {
                const response = await fetch('/assets/tools/vtracer/vtracer_real_bg.wasm');
                logResult(container, response.ok ? 'pass' : 'fail', 
                    `vtracer_real_bg.wasm: ${response.ok ? 'Found' : 'Not found'} (${response.status})`);
            } catch (e) {
                logResult(container, 'fail', 'vtracer_real_bg.wasm: Fetch failed', e.message);
            }
        };

        // WASM Loading Tests
        document.getElementById('run-wasm-tests').onclick = async () => {
            const container = document.getElementById('wasm-tests');
            container.innerHTML = '';
            
            logResult(container, 'info', 'Testing WASM module loading...');
            
            try {
                const mod = await import('/assets/tools/vtracer/vtracer_real.js');
                logResult(container, 'pass', 'WASM module imported successfully');
                
                // Check if default init function exists
                if (typeof mod.default === 'function') {
                    logResult(container, 'pass', 'Init function found');
                    
                    try {
                        await mod.default('/assets/tools/vtracer/vtracer_real_bg.wasm');
                        logResult(container, 'pass', 'WASM module initialized successfully');
                        
                        // Check for our function
                        if (typeof mod.convert_image_to_svg === 'function') {
                            logResult(container, 'pass', 'convert_image_to_svg function found');
                            
                            // Test with minimal data
                            try {
                                const testData = new Uint8Array(4 * 4 * 4); // 2x2 RGBA
                                testData.fill(255); // White pixels
                                
                                const result = mod.convert_image_to_svg(
                                    testData, 2, 2, // 2x2 image
                                    6, 4, 16, 60, 4.0, 45, "spline", "stacked"
                                );
                                
                                logResult(container, 'pass', 'Test conversion successful', {
                                    width: result.width,
                                    height: result.height,
                                    svgLength: result.svg_data.length
                                });
                                
                            } catch (testError) {
                                logResult(container, 'fail', 'Test conversion failed', testError.message);
                            }
                        } else {
                            logResult(container, 'fail', 'convert_image_to_svg function not found');
                        }
                        
                    } catch (initError) {
                        logResult(container, 'fail', 'WASM initialization failed', initError.message);
                    }
                } else {
                    logResult(container, 'fail', 'No init function found');
                }
                
            } catch (importError) {
                logResult(container, 'fail', 'WASM module import failed', importError.message);
            }
        };

        // Image Processing Tests
        document.getElementById('run-image-tests').onclick = async () => {
            const container = document.getElementById('image-tests');
            container.innerHTML = '';
            const progress = document.getElementById('image-progress');
            
            logResult(container, 'info', 'Testing image processing...');
            
            // Create test images
            const testImages = [
                { name: 'Small solid', size: [4, 4], color: [255, 0, 0, 255] },
                { name: 'Medium gradient', size: [16, 16], color: 'gradient' },
                { name: 'Large checkerboard', size: [64, 64], color: 'checker' },
                { name: 'Bear-like complexity', size: [128, 128], color: 'complex' }
            ];
            
            let completed = 0;
            
            for (const test of testImages) {
                try {
                    logResult(container, 'info', `Testing ${test.name} (${test.size[0]}x${test.size[1]})`);
                    
                    // Create ImageData
                    const [w, h] = test.size;
                    const imageData = new ImageData(w, h);
                    
                    // Fill with test pattern
                    for (let y = 0; y < h; y++) {
                        for (let x = 0; x < w; x++) {
                            const i = (y * w + x) * 4;
                            let color = [255, 255, 255, 255];
                            
                            if (test.color === 'gradient') {
                                color = [Math.floor(255 * x / w), Math.floor(255 * y / h), 128, 255];
                            } else if (test.color === 'checker') {
                                color = ((x + y) % 2) ? [0, 0, 0, 255] : [255, 255, 255, 255];
                            } else if (test.color === 'complex') {
                                // Create a bear-like pattern
                                const centerX = w / 2, centerY = h / 2;
                                const dist = Math.sqrt((x - centerX) ** 2 + (y - centerY) ** 2);
                                const rings = Math.sin(dist * 0.3) > 0 ? [139, 69, 19, 255] : [255, 248, 220, 255];
                                color = rings;
                            } else if (Array.isArray(test.color)) {
                                color = test.color;
                            }
                            
                            imageData.data[i] = color[0];
                            imageData.data[i + 1] = color[1];
                            imageData.data[i + 2] = color[2];
                            imageData.data[i + 3] = color[3];
                        }
                    }
                    
                    // Test with worker (like real usage)
                    await testWithWorker(container, test.name, imageData);
                    
                    completed++;
                    progress.style.width = `${(completed / testImages.length) * 100}%`;
                    
                } catch (error) {
                    logResult(container, 'fail', `${test.name} failed`, error.message);
                }
            }
        };

        async function testWithWorker(container, testName, imageData) {
            return new Promise((resolve, reject) => {
                const worker = new Worker('/src/vtrace/vtracerWorker.ts', { type: 'module' });
                
                const timeout = setTimeout(() => {
                    worker.terminate();
                    reject(new Error('Worker timeout (10s)'));
                }, 10000);
                
                worker.onmessage = (e) => {
                    clearTimeout(timeout);
                    worker.terminate();
                    
                    if (e.data.error) {
                        logResult(container, 'fail', `${testName} worker error`, e.data.error);
                        reject(new Error(e.data.error));
                    } else {
                        const paths = e.data.paths || [];
                        const svg = e.data.svg || '';
                        
                        if (paths.length > 0) {
                            logResult(container, 'pass', `${testName} success`, {
                                paths: paths.length,
                                svgSize: svg.length,
                                firstPath: paths[0]?.substring(0, 50) + '...'
                            });
                            
                            // Create visual test result
                            const testDiv = document.createElement('div');
                            testDiv.className = 'image-test';
                            
                            // Show original
                            const canvas = document.createElement('canvas');
                            canvas.width = imageData.width;
                            canvas.height = imageData.height;
                            canvas.className = 'test-image';
                            const ctx = canvas.getContext('2d');
                            ctx.putImageData(imageData, 0, 0);
                            
                            // Show result
                            const svgDiv = document.createElement('div');
                            svgDiv.innerHTML = svg;
                            svgDiv.className = 'test-svg';
                            
                            const info = document.createElement('div');
                            info.innerHTML = `<strong>${testName}</strong><br>
                                Paths: ${paths.length}<br>
                                Size: ${imageData.width}x${imageData.height}<br>
                                SVG: ${svg.length} chars`;
                            
                            testDiv.appendChild(canvas);
                            testDiv.appendChild(svgDiv);
                            testDiv.appendChild(info);
                            container.appendChild(testDiv);
                            
                            resolve(e.data);
                        } else {
                            logResult(container, 'warn', `${testName} no paths generated`, { svg: svg.substring(0, 100) });
                            resolve(e.data);
                        }
                    }
                };
                
                worker.onerror = (error) => {
                    clearTimeout(timeout);
                    worker.terminate();
                    logResult(container, 'fail', `${testName} worker error`, error.message);
                    reject(error);
                };
                
                worker.postMessage({
                    imageData,
                    options: {
                        mode: 'spline',
                        hierarchical: 'stacked',
                        filter_speckle: 4,
                        color_precision: 6,
                        layer_difference: 16,
                        corner_threshold: 60,
                        length_threshold: 4.0,
                        splice_threshold: 45
                    }
                });
            });
        }

        // Export results
        document.getElementById('export-results').onclick = () => {
            const results = document.getElementById('test-results').innerHTML;
            const blob = new Blob([`
                <html><head><title>VTracer Test Results</title></head>
                <body style="font-family: sans-serif; padding: 20px;">
                    <h1>VTracer WASM Test Results</h1>
                    <p>Generated: ${new Date().toISOString()}</p>
                    ${results}
                </body></html>
            `], { type: 'text/html' });
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'vtracer-test-results.html';
            a.click();
        };
    </script>
</body>
</html>
